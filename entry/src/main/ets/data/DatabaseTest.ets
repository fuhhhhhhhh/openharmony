import { DatabaseHelper } from './DatabaseHelper';

/**
 * æ•°æ®å±‚åŠŸèƒ½æµ‹è¯•ç±»
 * ç”¨äºéªŒè¯æ•°æ®åº“æ“ä½œæ˜¯å¦æ­£å¸¸å·¥ä½œ
 */
export class DatabaseTest {

  /**
   * è¿è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
   */
  public static async runFullTest(): Promise<string> {
    const results: string[] = [];

    try {
      // 1. åˆå§‹åŒ–æµ‹è¯•
      results.push('ğŸ“‹ å¼€å§‹æ•°æ®åº“åŠŸèƒ½æµ‹è¯•...');

      await DatabaseHelper.initialize();
      results.push('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');

      // 2. è·å–DAOå®ä¾‹
      const categoryDao = DatabaseHelper.getCategoryDao();
      const transactionDao = DatabaseHelper.getTransactionDao();
      results.push('âœ… DAOå®ä¾‹è·å–æˆåŠŸ');

      // 3. åˆ†ç±»CRUDæµ‹è¯•
      const categoryId = await categoryDao.insertCategory({
        name: 'æµ‹è¯•åˆ†ç±»',
        icon_name: 'test',
        type: 0
      });
      results.push(`âœ… åˆ†ç±»åˆ›å»ºæˆåŠŸï¼ŒID: ${categoryId}`);

      const categories = await categoryDao.getAllCategories();
      results.push(`âœ… åˆ†ç±»æŸ¥è¯¢æˆåŠŸï¼Œå…± ${categories.length} ä¸ªåˆ†ç±»`);

      // 4. äº¤æ˜“CRUDæµ‹è¯•
      const transactionId = await transactionDao.insertTransaction({
        type: 0,
        amount: 100.50,
        category_id: categoryId,
        date: Date.now(),
        note: 'æµ‹è¯•äº¤æ˜“'
      });
      results.push(`âœ… äº¤æ˜“åˆ›å»ºæˆåŠŸï¼ŒID: ${transactionId}`);

      const transactions = await transactionDao.getTransactions({ limit: 10 });
      results.push(`âœ… äº¤æ˜“æŸ¥è¯¢æˆåŠŸï¼Œå…± ${transactions.length} ç¬”äº¤æ˜“`);

      // 5. èšåˆæŸ¥è¯¢æµ‹è¯•
      const now = new Date();
      const stats = await transactionDao.getMonthlyCategoryStats(
        now.getFullYear(),
        now.getMonth() + 1,
        0
      );
      results.push(`âœ… æœˆåº¦ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸï¼Œ${stats.length} ä¸ªåˆ†ç±»æœ‰ç»Ÿè®¡æ•°æ®`);

      // 6. æ¸…ç†æµ‹è¯•æ•°æ®
      const deleteResult = await categoryDao.deleteCategory(categoryId);
      results.push(`âœ… æµ‹è¯•æ•°æ®æ¸…ç†${deleteResult ? 'æˆåŠŸ' : 'å¤±è´¥'}`);

      results.push('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®å±‚åŠŸèƒ½æ­£å¸¸');

    } catch (error) {
      results.push(`âŒ æµ‹è¯•å¤±è´¥: ${(error as Error).message}`);
    }

    return results.join('\n');
  }

  /**
   * å¿«é€Ÿåˆå§‹åŒ–æµ‹è¯•
   */
  public static async testInitialization(): Promise<string> {
    try {
      await DatabaseHelper.initialize();
      return 'âœ… æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•æˆåŠŸ';
    } catch (error) {
      return `âŒ æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ${(error as Error).message}`;
    }
  }

  /**
   * åŸºæœ¬CRUDæµ‹è¯•
   */
  public static async testBasicCRUD(): Promise<string> {
    try {
      const categoryDao = DatabaseHelper.getCategoryDao();

      // åˆ›å»ºæµ‹è¯•åˆ†ç±»
      const categoryId = await categoryDao.insertCategory({
        name: 'CRUDæµ‹è¯•',
        type: 0
      });

      // æŸ¥è¯¢éªŒè¯
      const categories = await categoryDao.getAllCategories();
      const found = categories.some(c => c.id === categoryId);

      // æ¸…ç†
      await categoryDao.deleteCategory(categoryId);

      return found ? 'âœ… åŸºç¡€CRUDæµ‹è¯•æˆåŠŸ' : 'âŒ CRUDæµ‹è¯•å¤±è´¥ï¼šæ•°æ®æœªæ‰¾åˆ°';
    } catch (error) {
      return `âŒ åŸºç¡€CRUDæµ‹è¯•å¤±è´¥: ${(error as Error).message}`;
    }
  }
}
