import { DatabaseHelper } from '../data/DatabaseHelper';
import { DatabaseTest } from '../data/DatabaseTest';

@Entry
@Component
struct Index {
  @State message: string = 'è®°è´¦æœ¬ App';
  @State statusMessage: string = 'ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ•°æ®åº“åŠŸèƒ½';

  build() {
    Column() {
      Text(this.message)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 50, bottom: 20 })

      Text(this.statusMessage)
        .fontSize(16)
        .margin({ bottom: 30 })
        .textAlign(TextAlign.Center)

      Button('æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            await DatabaseHelper.initialize();
            this.statusMessage = 'âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ';
          } catch (error) {
            this.statusMessage = `âŒ åˆå§‹åŒ–å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('æ·»åŠ æµ‹è¯•æ•°æ®')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const categoryDao = DatabaseHelper.getCategoryDao();
            const transactionDao = DatabaseHelper.getTransactionDao();

            // æ·»åŠ æµ‹è¯•åˆ†ç±»
            const categoryId: number = await categoryDao.insertCategory({
              name: 'é¤é¥®',
              icon_name: 'food',
              type: 0
            });

            // æ·»åŠ æµ‹è¯•äº¤æ˜“
            await transactionDao.insertTransaction({
              type: 0,
              amount: 25.50,
              category_id: categoryId,
              date: Date.now(),
              note: 'åˆé¤æµ‹è¯•'
            });

            this.statusMessage = 'âœ… æµ‹è¯•æ•°æ®æ·»åŠ æˆåŠŸ';
          } catch (error) {
            this.statusMessage = `âŒ æ·»åŠ æ•°æ®å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('æŸ¥è¯¢æ•°æ®')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const categoryDao = DatabaseHelper.getCategoryDao();
            const transactionDao = DatabaseHelper.getTransactionDao();

            const categories = await categoryDao.getAllCategories();
            const transactions = await transactionDao.getTransactions({ limit: 10 });

            this.statusMessage = `âœ… æŸ¥è¯¢æˆåŠŸ: ${categories.length}ä¸ªåˆ†ç±», ${transactions.length}ç¬”äº¤æ˜“`;
          } catch (error) {
            this.statusMessage = `âŒ æŸ¥è¯¢å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('æœˆåº¦ç»Ÿè®¡æµ‹è¯•')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const transactionDao = DatabaseHelper.getTransactionDao();
            const now: Date = new Date();
            const stats = await transactionDao.getMonthlyCategoryStats(now.getFullYear(), now.getMonth() + 1, 0);

            this.statusMessage = `âœ… æœ¬æœˆç»Ÿè®¡: ${stats.length}ä¸ªåˆ†ç±»æœ‰æ”¯å‡ºè®°å½•`;
          } catch (error) {
            this.statusMessage = `âŒ ç»Ÿè®¡å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('å®Œæ•´åŠŸèƒ½æµ‹è¯•')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          this.statusMessage = 'ğŸ”„ æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...';
          try {
            const result: string = await DatabaseTest.runFullTest();
            this.statusMessage = result;
          } catch (error) {
            this.statusMessage = `âŒ æµ‹è¯•å¼‚å¸¸: ${(error as Error).message}`;
          }
        })

      Button('æ¸…ç†æ•°æ®åº“')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            await DatabaseHelper.close();
            await DatabaseHelper.initialize();
            this.statusMessage = 'âœ… æ•°æ®åº“å·²æ¸…ç†å¹¶é‡æ–°åˆå§‹åŒ–';
          } catch (error) {
            this.statusMessage = `âŒ æ¸…ç†å¤±è´¥: ${(error as Error).message}`;
          }
        })
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .alignItems(HorizontalAlign.Center)
  }
}