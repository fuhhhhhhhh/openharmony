import { DatabaseHelper } from '../data/DatabaseHelper';
import { DatabaseTest } from '../data/DatabaseTest';

@Entry
@Component
struct Index {
  @State message: string = 'è®°è´¦æœ¬ App';
  @State statusMessage: string = 'ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ•°æ®åº“åŠŸèƒ½';
  @State transactionIdToDelete: string = '';

  build() {
    Column() {
      Text(this.message)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 50, bottom: 20 })

      Text(this.statusMessage)
        .fontSize(16)
        .margin({ bottom: 30 })
        .textAlign(TextAlign.Center)

      Button('æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            await DatabaseHelper.initialize();
            this.statusMessage = 'âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ';
          } catch (error) {
            this.statusMessage = `âŒ åˆå§‹åŒ–å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('æ·»åŠ æµ‹è¯•æ•°æ®')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const categoryDao = DatabaseHelper.getCategoryDao();
            const transactionDao = DatabaseHelper.getTransactionDao();

            // æ·»åŠ æµ‹è¯•åˆ†ç±»
            const categoryId: number = await categoryDao.insertCategory({
              name: 'é¤é¥®',
              icon_name: 'food',
              type: 0
            });

            // æ·»åŠ æµ‹è¯•äº¤æ˜“
            await transactionDao.insertTransaction({
              type: 0,
              amount: 25.50,
              category_id: categoryId,
              date: Date.now(),
              note: 'åˆé¤æµ‹è¯•'
            });

            this.statusMessage = 'âœ… æµ‹è¯•æ•°æ®æ·»åŠ æˆåŠŸ';
          } catch (error) {
            this.statusMessage = `âŒ æ·»åŠ æ•°æ®å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('æŸ¥è¯¢æ•°æ®')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const categoryDao = DatabaseHelper.getCategoryDao();
            const transactionDao = DatabaseHelper.getTransactionDao();

            const categories = await categoryDao.getAllCategories();
            const transactions = await transactionDao.getTransactions({ limit: 10 });

            this.statusMessage = `âœ… æŸ¥è¯¢æˆåŠŸ: ${categories.length}ä¸ªåˆ†ç±», ${transactions.length}ç¬”äº¤æ˜“`;
          } catch (error) {
            this.statusMessage = `âŒ æŸ¥è¯¢å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('æœˆåº¦ç»Ÿè®¡æµ‹è¯•')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const transactionDao = DatabaseHelper.getTransactionDao();
            const now: Date = new Date();
            const stats = await transactionDao.getMonthlyCategoryStats(now.getFullYear(), now.getMonth() + 1, 0);

            this.statusMessage = `âœ… æœ¬æœˆç»Ÿè®¡: ${stats.length}ä¸ªåˆ†ç±»æœ‰æ”¯å‡ºè®°å½•`;
          } catch (error) {
            this.statusMessage = `âŒ ç»Ÿè®¡å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('å®Œæ•´åŠŸèƒ½æµ‹è¯•')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          this.statusMessage = 'ğŸ”„ æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...';
          try {
            const result: string = await DatabaseTest.runFullTest();
            this.statusMessage = result;
          } catch (error) {
            this.statusMessage = `âŒ æµ‹è¯•å¼‚å¸¸: ${(error as Error).message}`;
          }
        })

      Button('æ¸…ç†æ•°æ®åº“')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            await DatabaseHelper.clearDatabase();
            this.statusMessage = 'âœ… æ•°æ®åº“å·²æ¸…ç†å¹¶é‡æ–°åˆå§‹åŒ–';
          } catch (error) {
            this.statusMessage = `âŒ æ¸…ç†å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('åˆ é™¤æ”¯å‡ºäº¤æ˜“')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const deletedCount = await DatabaseHelper.deleteTransactionsByType(0);
            this.statusMessage = `âœ… å·²åˆ é™¤ ${deletedCount} ç¬”æ”¯å‡ºäº¤æ˜“`;
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('åˆ é™¤æ”¶å…¥äº¤æ˜“')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const deletedCount = await DatabaseHelper.deleteTransactionsByType(1);
            this.statusMessage = `âœ… å·²åˆ é™¤ ${deletedCount} ç¬”æ”¶å…¥äº¤æ˜“`;
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('åˆ é™¤å°é¢äº¤æ˜“(<10)')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const deletedCount = await DatabaseHelper.deleteTransactionsByAmountRange(0, 10);
            this.statusMessage = `âœ… å·²åˆ é™¤ ${deletedCount} ç¬”å°é¢äº¤æ˜“`;
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('åˆ é™¤æœ¬æœˆäº¤æ˜“')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).getTime();

            const deletedCount = await DatabaseHelper.deleteTransactionsByDateRange(startOfMonth, endOfMonth);
            this.statusMessage = `âœ… å·²åˆ é™¤ ${deletedCount} ç¬”æœ¬æœˆäº¤æ˜“`;
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('åˆ é™¤æ”¯å‡ºåˆ†ç±»')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const deletedCount = await DatabaseHelper.deleteCategoriesByType(0);
            this.statusMessage = `âœ… å·²åˆ é™¤ ${deletedCount} ä¸ªæ”¯å‡ºåˆ†ç±»`;
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Button('åˆ é™¤æ”¶å…¥åˆ†ç±»')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const deletedCount = await DatabaseHelper.deleteCategoriesByType(1);
            this.statusMessage = `âœ… å·²åˆ é™¤ ${deletedCount} ä¸ªæ”¶å…¥åˆ†ç±»`;
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })

      Text('åˆ é™¤å•ä¸ªäº¤æ˜“è®°å½•')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10 })

      TextInput({ placeholder: 'è¾“å…¥äº¤æ˜“è®°å½•ID' })
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onChange((value: string) => {
          this.transactionIdToDelete = value;
        })

      Button('åˆ é™¤æŒ‡å®šäº¤æ˜“')
        .width(200)
        .height(40)
        .margin({ bottom: 10 })
        .onClick(async () => {
          try {
            const transactionId = parseInt(this.transactionIdToDelete.trim());
            if (isNaN(transactionId) || transactionId <= 0) {
              this.statusMessage = 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“è®°å½•ID';
              return;
            }

            const success = await DatabaseHelper.deleteTransaction(transactionId);
            if (success) {
              this.statusMessage = `âœ… å·²åˆ é™¤äº¤æ˜“è®°å½• ID: ${transactionId}`;
              this.transactionIdToDelete = '';
            } else {
              this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: äº¤æ˜“è®°å½• ID ${transactionId} ä¸å­˜åœ¨`;
            }
          } catch (error) {
            this.statusMessage = `âŒ åˆ é™¤å¤±è´¥: ${(error as Error).message}`;
          }
        })
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .alignItems(HorizontalAlign.Center)
  }
}